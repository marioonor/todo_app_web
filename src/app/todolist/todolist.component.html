<app-header></app-header>
<div
  class="hide-scrollbar"
  style="
    display: flex;
    flex-direction: row;
    min-height: 90vh;
    width: 100%;
    top: 0;
  "
>
  <app-sidebar></app-sidebar>
  <div
    class="container-fluid"
    style="
      background-color: #6aa7e4;
      padding-top: 10px;
      overflow-y: auto;
      padding-bottom: 20px;
    "
  >
    <div class="row">
      <div class="col-12"></div>
    </div>
    <div class="text-center">
      <!-- Display button selection -->
      <div
        class="d-flex justify-content-between align-items-center"
        style="color: white; margin: 20px 0"
      >
        <div class="btn-group" style="margin-left: 20px">
          <div
            role="button"
            class="btn-secondary me-2 add-todo-btn kanban"
            (click)="setView('kanban')"
            [class.active]="currentView === 'kanban'"
          >
            Kanban View
          </div>
          <div
            role="button"
            class="btn-secondary add-todo-btn list"
            (click)="setView('simpleList')"
            [class.active]="currentView === 'simpleList'"
          >
            List View
          </div>
        </div>
        <div class="input-group custom-search-bar">
          <input
            type="text"
            class="form-control"
            placeholder="Search ..."
            aria-label="Search"
            [(ngModel)]="searchText"
          />
          <button class="btn btn-primary" type="button">
            <i class="bi bi-search"></i>
            <!-- Bootstrap Icons -->
          </button>
        </div>

        <div
          class="nav-item hover add-task-btn"
          data-bs-toggle="modal"
          data-bs-target="#addTodoModal"
          (click)="openAddTodoModal()"
          role="button"
        >
          <p class="add-task-text">Add Task</p>
          <img [src]="imageAddTask" alt="Add Task" class="add-task-icon" />
        </div>
      </div>
      <!-- Display button selection -->
    </div>

    <div *ngIf="isLoading" class="text-center my-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p>Loading todos...</p>
    </div>

    <div
      *ngIf="!isLoading && errorMessage"
      class="text-center text-danger my-5"
    >
      <p>{{ errorMessage }}</p>
      <button class="btn btn-outline-primary" (click)="loadTodos()">
        Try Again
      </button>
    </div>

    <div
      *ngIf="!isLoading && !errorMessage && (todos?.length ?? 0) === 0"
      class="text-center my-5"
    >
      <p>No todos found. Click "Add Todo" to create one!</p>
    </div>

    <div
      *ngIf="!isLoading && !errorMessage && (todos?.length ?? 0) > 0"
      class="row g-3"
    >
      <div
        class="col-12 col-md-6 col-lg-3"
        *ngFor="let status of connectedLists"
      >
        <div
          class="card"
          *ngIf="currentView === 'kanban'"
          style="
            margin-left: 10px;
            margin: 5px;
            overflow-y: auto;
            max-height: 83vh;
            border-radius: 10px;
          "
        >
          <div
            class="card-header text-center"
            [ngClass]="getStatusClass(status)"
            style="position: sticky; top: 0; z-index: 1"
          >
            <strong>{{ getStatusLabel(status) }}</strong>
          </div>
          <div
            class="card-body d-flex flex-column gap-3 hide-scrollbar"
            style="min-height: 250px; overflow-y: auto"
            cdkDropList
            [id]="status"
            [cdkDropListData]="getTodosByStatus(status)"
            [cdkDropListConnectedTo]="connectedLists"
            (cdkDropListDropped)="onDrop($event)"
          >
            <ng-container *ngIf="getTodosByStatus(status).length === 0">
              <p class="text-muted text-center my-auto">No tasks here</p>
            </ng-container>
            <div>
              <div class="todo-column">
                <ng-container *ngFor="let todo of filteredItems(status)">
                  <div
                    class="card shadow-sm mb-2"
                    cdkDrag
                    [cdkDragData]="todo"
                    [cdkDragDisabled]="!todo.isDraggable"
                    (dblclick)="enableDrag(todo)"
                    (cdkDragEnded)="disableDragOnEnd($event)"
                  >
                    <div class="card-body pt-3 px-3 pb-2">
                      <h5 class="card-title">{{ todo.title }}</h5>
                      <p class="card-text">{{ todo.description }}</p>
                      <p class="mb-1">
                        <small
                          ><strong>Start:</strong>
                          {{ todo.dateStart | date : "yyyy-MM-dd" }}</small
                        ><br />
                        <small
                          ><strong>End:</strong>
                          {{ todo.dateEnd | date : "yyyy-MM-dd" }}</small
                        ><br />
                        <small
                          ><strong>Due:</strong>
                          {{ todo.dueDate | date : "yyyy-MM-dd" }}</small
                        >
                      </p>
                      <p *ngIf="todo.remarks" class="mb-1">
                        <small
                          ><em>Remarks: {{ todo.remarks }}</em></small
                        >
                      </p>

                      <div
                        class="d-flex justify-content-between align-items-center mt-2"
                      >
                        <span
                          class="badge p-2"
                          [ngClass]="
                            getPriorityClass(
                              todo.priority === 'HIGH'
                                ? 'CRITICAL'
                                : todo.priority === 'MEDIUM'
                                ? 'NORMAL'
                                : todo.priority
                            )
                          "
                        >
                          {{
                            todo.priority === "HIGH"
                              ? "CRITICAL"
                              : todo.priority === "MEDIUM"
                              ? "NORMAL"
                              : todo.priority
                          }}
                        </span>
                      </div>

                      <div
                        class="d-flex justify-content-end align-items-center mt-2"
                      >
                        <div>
                          <button
                            type="button"
                            class="btn btn-sm me-1"
                            style="padding: 2px 5px"
                            data-bs-toggle="modal"
                            data-bs-target="#editTodoModal"
                            (click)="selectTodoForEdit(todo)"
                            title="Edit Task"
                          >
                            <img
                              [src]="edit"
                              style="width: 18px; height: 18px"
                              alt="Edit"
                            />
                          </button>
                          <button
                            type="button"
                            class="btn btn-sm me-1"
                            style="padding: 2px 5px"
                            (click)="deleteTodo(todo.id!)"
                            title="Delete Task"
                          >
                            <img
                              [src]="delete"
                              style="width: 18px; height: 18px"
                              alt="Delete"
                            />
                          </button>
                        </div>
                        <!-- Quick Status Change Handle -->
                        <div
                          (mouseenter)="showQuickStatusOptions(todo, $event)"
                          (mouseleave)="
                            startHideQuickStatusPopoverTimer(todo.id!)
                          "
                          title="Quick change status"
                        >
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="16"
                            height="16"
                            fill="currentColor"
                            class="bi bi-three-dots-vertical"
                            viewBox="0 0 16 16"
                          >
                            <path
                              d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"
                            />
                          </svg>
                        </div>
                        <div
                          *ngIf="
                            quickStatusPopover.todoId === todo.id &&
                            quickStatusPopover.visible
                          "
                          class="status-options-popover"
                          [style.top]="quickStatusPopover.top"
                          [style.left]="quickStatusPopover.left"
                          (mouseenter)="cancelHideQuickStatusPopoverTimer()"
                          (mouseleave)="
                            startHideQuickStatusPopoverTimer(todo.id!)
                          "
                          (click)="$event.stopPropagation()"
                        >
                          <button
                            *ngFor="let statOpt of connectedLists"
                            [disabled]="statOpt === todo.status"
                            type="button"
                            style="padding: 0;"
                            class="btn btn-sm d-block w-100 mb-1 text-start status-option-button"
                            (click)="updateTodoStatusQuick(todo, statOpt)"
                            [style.--status-accent-color]="getStatusAccentColor(statOpt)"
                            [style.--status-contrast-color]="getStatusContrastColorForAccent(statOpt)"
                          >
                            <img
                              [src]="getStatusImages(statOpt)"
                              [alt]="statOpt"
                              style="
                                width: 20px;
                                height: 20px;
                                vertical-align: middle;
                              "
                            />
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </ng-container>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Simple List View -->

    <div
      class="table-responsive"
      *ngIf="currentView === 'simpleList'"
      style="border-radius: 10px"
    >
      <div class="hide-scrollbar" style="height: 80vh; overflow-y: auto">
        <table class="table table-striped table-hover mb-0">
          <thead
            class="thead-dark text-nowrap sticky-header"
            style="
              position: sticky;
              top: 0;
              z-index: 1;
              background-color: #343a40;
              color: white;
            "
          >
            <tr class="text-center">
              <th>Title</th>
              <th>Description</th>
              <th>Status</th>
              <th>Remarks</th>
              <th>Date Start</th>
              <th>Date End</th>
              <th>Due Date</th>
              <th>Priority</th>
              <th>Action</th>
            </tr>
          </thead>

          <tbody *ngIf="isLoading">
            <tr>
              <td colspan="9" class="text-center">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p>Loading todos...</p>
              </td>
            </tr>
          </tbody>

          <tbody *ngIf="!isLoading && errorMessage">
            <tr>
              <td colspan="9" class="text-center text-danger">
                <p>{{ errorMessage }}</p>
                <button
                  type="button"
                  class="btn btn-sm btn-outline-primary"
                  (click)="loadTodos()"
                >
                  Try Again
                </button>
              </td>
            </tr>
          </tbody>

          <tbody *ngIf="!isLoading && !errorMessage && todos?.length === 0">
            <tr>
              <td colspan="9" class="text-center">
                <p>No todos found. Click "Add Todo" to create one!</p>
              </td>
            </tr>
          </tbody>

          <tbody
            *ngIf="!isLoading && !errorMessage && (todos?.length ?? 0) > 0"
          >
            <tr *ngFor="let todo of filteredItems('ALL')" class="text-center">
              <td>{{ todo.title }}</td>
              <td class="description-cell">{{ todo.description }}</td>
              <td class="text-nowrap">
                <span
                  class="badge"
                  style="padding: 5px 10px"
                  [ngClass]="getStatusClass(todo.status)"
                >
                  {{ getStatusLabel(todo.status) }}
                </span>
              </td>
              <td>{{ todo.remarks }}</td>
              <td class="text-nowrap">
                {{ todo.dateStart | date : "yyyy-MM-dd" }}
              </td>
              <td class="text-nowrap">
                {{ todo.dateEnd | date : "yyyy-MM-dd" }}
              </td>
              <td class="text-nowrap">
                {{ todo.dueDate | date : "yyyy-MM-dd" }}
              </td>
              <td class="text-nowrap">{{ todo.priority }}</td>
              <td class="text-nowrap">
                <button
                  type="button"
                  class="btn btn-sm"
                  (click)="selectTodoForEdit(todo)"
                  data-bs-toggle="modal"
                  data-bs-target="#editTodoModal"
                  style="padding: 5px 10px; margin: 5px"
                >
                  <img [src]="edit" style="width: auto; height: 20px" alt="" />
                </button>
                <button
                  type="button"
                  class="btn btn-sm"
                  (click)="deleteTodo(todo.id!)"
                  style="padding: 5px 10px"
                >
                  <img
                    [src]="delete"
                    style="width: auto; height: 20px"
                    alt=""
                  />
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Simple List View -->

    <!-- Quick Status Change Popover (Single instance for the component) -->
    <!-- End Quick Status Change Popover -->
  </div>

  <!-- Add Task Modal -->
  <div
    class="modal fade"
    id="addTodoModal"
    tabindex="-1"
    aria-labelledby="addTodoModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-lg">
      <div
        class="modal-content"
        style="padding: 30px; background-color: #79b6f2; color: white"
      >
        <div class="modal-header">
          <img
            [src]="imageAddTask"
            class="btn-success"
            style="width: 40px; height: 40px; padding: 5px"
            alt=""
          />
          <h5 class="modal-title" id="addTodoModalLabel">Add New Task</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <form (ngSubmit)="onAddTodo(addTodoForm)" #addTodoForm="ngForm">
            <div class="mb-3">
              <label for="addTitle" class="form-label">Task Name:</label>
              <input
                type="text"
                class="form-control"
                id="addTitle"
                name="title"
                [(ngModel)]="newTodo.title"
                required
                #title="ngModel"
                [attr.aria-invalid]="
                  title.invalid && (title.dirty || title.touched)
                    ? 'true'
                    : 'false'
                "
                aria-describedby="addTitleError"
              />
              <div
                *ngIf="title.invalid && (title.dirty || title.touched)"
                id="addTitleError"
                class="text-danger"
              >
                Task Name is required.
              </div>
            </div>
            <div class="mb-3">
              <label for="addDescription" class="form-label"
                >Description:</label
              >
              <textarea
                class="form-control"
                id="addDescription"
                name="description"
                [(ngModel)]="newTodo.description"
                #description="ngModel"
                [attr.aria-invalid]="
                  description.invalid &&
                  (description.dirty || description.touched)
                    ? 'true'
                    : 'false'
                "
                aria-describedby="addDescriptionError"
              ></textarea>
            </div>
            <div class="row">
              <!-- Project Name Location ---------------------------------------------------------------------------------->
              <div class="col-md-6 mb-3">
                <label for="addTodoProject" class="form-label">Project:</label>
                <select
                  class="form-select"
                  id="addTodoProject"
                  name="addTodoProject"
                  [(ngModel)]="selectedProjectIdForNewTodo"
                  required
                  #todoProject="ngModel"
                >
                  <option [ngValue]="null" disabled>Select a project</option>
                  <option *ngFor="let project of projects" [value]="project.id">
                    {{ project.project }}
                  </option>
                </select>
                <div
                  *ngIf="
                    todoProject.invalid &&
                    (todoProject.dirty || todoProject.touched)
                  "
                  class="text-danger"
                >
                  Project is required.
                </div>
              </div>
              <!-- Project Name Location ------------------------------------------------------------------------------------>

              <div class="col-md-6 mb-3">
                <div
                  *ngIf="status.invalid && (status.dirty || status.touched)"
                  id="addStatusError"
                  class="text-danger"
                >
                  Status is required.
                </div>
                <label for="addRemarks" class="form-label"
                  >Remarks (Optional):</label
                >
                <textarea
                  class="form-control"
                  id="addRemarks"
                  name="remarks"
                  [(ngModel)]="newTodo.remarks"
                  #description="ngModel"
                ></textarea>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="addDateStart" class="form-label">Start Date:</label>
                <input
                  type="date"
                  class="form-control"
                  id="addDateStart"
                  name="dateStart"
                  [(ngModel)]="newTodo.dateStart"
                  #dateStart="ngModel"
                  [attr.aria-invalid]="
                    dateStart.invalid && (dateStart.dirty || dateStart.touched)
                      ? 'true'
                      : 'false'
                  "
                  aria-describedby="addDateStartError"
                />
              </div>
              <div class="col-md-6 mb-3">
                <label for="addDateEnd" class="form-label"
                  >Target End Date:</label
                >
                <input
                  type="date"
                  class="form-control"
                  id="addDateEnd"
                  name="dateEnd"
                  [(ngModel)]="newTodo.dateEnd"
                  #dateEnd="ngModel"
                  [attr.aria-invalid]="
                    dateEnd.invalid && (dateEnd.dirty || dateEnd.touched)
                      ? 'true'
                      : 'false'
                  "
                  aria-describedby="addDateEndError"
                />
              </div>
            </div>
            <div class="row">
              <!-- Added field (Start)-->
              <div class="col-md-6 mb-3">
                <label for="addDueDate" class="form-label">Due Date:</label>
                <input
                  type="date"
                  class="form-control"
                  id="addDueDate"
                  name="dueDate"
                  [(ngModel)]="newTodo.dueDate"
                  #dateEnd="ngModel"
                />
              </div>
              <!-- Added field (End)-->
              <!-- Project Name Location -->
              <!-- Added field (Start)-->
              <div class="col-md-6 mb-3">
                <label for="addStatus" class="form-label">Status:</label>
                <select
                  class="form-select"
                  id="addStatus"
                  name="status"
                  [(ngModel)]="newTodo.status"
                  required
                  #status="ngModel"
                  [attr.aria-invalid]="
                    status.invalid && (status.dirty || status.touched)
                      ? 'true'
                      : 'false'
                  "
                  aria-describedby="addStatusError"
                >
                  <option value="PENDING">Pending</option>
                  <option value="IN_PROGRESS">In Progress</option>
                  <option value="COMPLETED">Completed</option>
                  <option value="CANCELLED">Cancelled</option>
                </select>
              </div>
            </div>
            <!-- Added field (End)-->
            <!-- Priority Field and Subtasks Field -->
            <!-- Subtasks Field -->
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="">Add Subtasks:</label>
                <ul
                  class="list-unstyled"
                  style="display: flex; flex-direction: column; gap: 5px"
                >
                  <!-- Input for new task -->
                  <li>
                    <div class="input-group mb-3">
                      <input
                        type="text"
                        class="form-control"
                        id="subtaskInputAdd"
                        name="subtaskInputAdd"
                        [(ngModel)]="newTaskForAddModal"
                        (keydown.enter)="
                          addTaskOnEnter(undefined, 'add');
                          $event.preventDefault()
                        "
                      />

                      <button
                        type="button"
                        class="btn btn-primary"
                        (click)="addTaskOnEnter(undefined, 'add')"
                      >
                        <img
                          [src]="add"
                          style="width: auto; height: 20px"
                          alt=""
                        />
                      </button>
                    </div>
                  </li>

                  <!-- Subtask list -->

                  <!-- Added field (End)----------------------------------------------------------------------->
                </ul>
              </div>
              <!-- Priority Field -->

              <div class="col-md-6 mb-3">
                <label for="addPriority" class="form-label"> Priority: </label>
                <select
                  class="form-select"
                  id="addPriority"
                  name="priority"
                  [(ngModel)]="newTodo.priority"
                  required
                  #addPriority="ngModel"
                  [attr.aria-invalid]="
                    addPriority.invalid &&
                    (addPriority.dirty || addPriority.touched)
                      ? 'true'
                      : 'false'
                  "
                  aria-describedby="addPriorityError"
                >
                  <option value="CRITICAL">Critical/Urgent/High</option>
                  <option value="IMPORTANT">Important/High Priority</option>
                  <option value="NORMAL">Normal/Medium Priority</option>
                  <option value="LOW">Low Priority</option>
                </select>

                <div
                  *ngIf="
                    addPriority.invalid &&
                    (addPriority.dirty || addPriority.touched)
                  "
                  id="addPriorityError"
                  class="text-danger"
                >
                  Priority is required.
                </div>
              </div>
              <div class="row">
                <div
                  style="
                    background-color: rgb(255, 255, 255);
                    padding: 10px;
                    width: 100%;
                    border-radius: 5px;
                    color: black;
                    margin-left: 13px;
                  "
                >
                  <label class="form-label">Subtasks:</label>
                  <ul class="list-unstyled">
                    <li
                      *ngFor="
                        let subtask of pendingSubtasksForNewTodo;
                        let i = index
                      "
                    >
                      <input
                        type="checkbox"
                        [checked]="subtask.completed"
                        (change)="togglePendingSubtaskComplete(subtask)"
                      />
                      <span
                        class="ms-2 flex-grow-1"
                        [ngClass]="{
                          'text-decoration-line-through': subtask.completed
                        }"
                      >
                        {{ subtask.subtasks }}
                      </span>
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-light ms-2"
                        (click)="editPendingSubtask(i)"
                        title="Edit Subtask"
                        style="padding: 0.1rem 0.3rem; font-size: 0.7rem"
                      >
                        <img
                          [src]="edit"
                          style="width: 12px; height: 12px"
                          alt="Edit"
                        />
                      </button>
                      <button
                        type="button"
                        class="btn btn-sm ms-2"
                        (click)="removePendingSubtask(i)"
                        title="Remove Subtask"
                        style="padding: 0.1rem 0.3rem; font-size: 0.7rem"
                      >
                        <img
                          [src]="delete"
                          style="width: 12px; height: 12px"
                          alt="Remove"
                        />
                      </button>
                    </li>
                    <li
                      *ngIf="pendingSubtasksForNewTodo.length === 0"
                      class="text-muted"
                    >
                      No subtasks added yet.
                    </li>
                  </ul>
                </div>
              </div>
            </div>
            <!-- Priority Fields and Subtasks Field -->
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cancel
              </button>
              <button
                type="submit"
                class="btn btn-primary"
                [disabled]="addTodoForm.invalid"
              >
                Save Todo
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  <!-- Add Task Modal -->

  <!-- Edit Task Modal -->
  <div
    class="modal fade"
    id="editTodoModal"
    tabindex="-1"
    aria-labelledby="editTodoModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-lg">
      <div
        class="modal-content"
        style="padding: 30px; background-color: #79b6f2; color: white"
      >
        <div class="modal-header">
          <img
            [src]="imageAddTask"
            class="btn-success"
            style="width: 40px; height: 40px; padding: 5px"
            alt=""
          />
          <h5 class="modal-title" id="editTodoModalLabel">Edit Todo</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body" *ngIf="editTodoData">
          <form (ngSubmit)="onUpdateTodo(editTodoForm)" #editTodoForm="ngForm">
            <input type="hidden" name="id" [(ngModel)]="editTodoData.id" />

            <div class="mb-3">
              <label for="editTitle" class="form-label">Task Name:</label>
              <input
                type="text"
                class="form-control"
                id="editTitle"
                name="title"
                [(ngModel)]="editTodoData.title"
                required
                #editTitle="ngModel"
                [attr.aria-invalid]="
                  editTitle.invalid && (editTitle.dirty || editTitle.touched)
                    ? 'true'
                    : 'false'
                "
                aria-describedby="editTitleError"
              />
              <div
                *ngIf="
                  editTitle.invalid && (editTitle.dirty || editTitle.touched)
                "
                id="editTitleError"
                class="text-danger"
              >
                Title is required.
              </div>
            </div>
            <div class="mb-3">
              <label for="editDescription" class="form-label"
                >Description:</label
              >
              <textarea
                class="form-control"
                id="editDescription"
                name="description"
                [(ngModel)]="editTodoData.description"
                required
                #editDescription="ngModel"
                [attr.aria-invalid]="
                  editDescription.invalid &&
                  (editDescription.dirty || editDescription.touched)
                    ? 'true'
                    : 'false'
                "
                aria-describedby="editDescriptionError"
              ></textarea>
              <div
                *ngIf="
                  editDescription.invalid &&
                  (editDescription.dirty || editDescription.touched)
                "
                id="editDescriptionError"
                class="text-danger"
              >
                Description is required.
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="editTodoProject" class="form-label">Project:</label>
                <select
                  class="form-select"
                  id="editTodoProject"
                  name="editTodoProject"
                  [(ngModel)]="editTodoData.project!.id"
                  required
                  #editProject="ngModel"
                >
                  <option [ngValue]="null" disabled>Select a project</option>
                  <option *ngFor="let project of projects" [value]="project.id">
                    {{ project.project }}
                  </option>
                </select>
                <div
                  *ngIf="
                    editProject.invalid &&
                    (editProject.dirty || editProject.touched)
                  "
                  class="text-danger"
                >
                  Project is required.
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <div
                  *ngIf="
                    editStatus.invalid &&
                    (editStatus.dirty || editStatus.touched)
                  "
                  id="editStatusError"
                  class="text-danger"
                >
                  Status is required.
                </div>
                <label for="editRemarks" class="form-label"
                  >Remarks (Optional):</label
                >
                <textarea
                  class="form-control"
                  id="editRemarks"
                  name="remarks"
                  [(ngModel)]="editTodoData.remarks"
                  #description="ngModel"
                ></textarea>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="editDateStart" class="form-label"
                  >Start Date:</label
                >
                <input
                  type="date"
                  class="form-control"
                  id="editDateStart"
                  name="dateStart"
                  [(ngModel)]="editTodoData.dateStart"
                  #editDateStart="ngModel"
                  [attr.aria-invalid]="
                    editDateStart.invalid &&
                    (editDateStart.dirty || editDateStart.touched)
                      ? 'true'
                      : 'false'
                  "
                  aria-describedby="editDateStartError"
                />
              </div>
              <div class="col-md-6 mb-3">
                <label for="editDateEnd" class="form-label">End Date:</label>
                <input
                  type="date"
                  class="form-control"
                  id="editDateEnd"
                  name="dateEnd"
                  [(ngModel)]="editTodoData.dateEnd"
                  #editDateEnd="ngModel"
                  [attr.aria-invalid]="
                    editDateEnd.invalid &&
                    (editDateEnd.dirty || editDateEnd.touched)
                      ? 'true'
                      : 'false'
                  "
                  aria-describedby="editDateEndError"
                />
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="editDueDate" class="form-label">Due Date:</label>
                <input
                  type="date"
                  class="form-control"
                  id="addDueDate"
                  name="dueDate"
                  [(ngModel)]="editTodoData.dueDate"
                  #editDueDate="ngModel"
                  [attr.aria-invalid]="
                    editDueDate.invalid &&
                    (editDueDate.dirty || editDueDate.touched)
                      ? 'true'
                      : 'false'
                  "
                  aria-describedby="editDateEndError"
                />
              </div>
              <div class="col-md-6 mb-3">
                <label for="editStatus" class="form-label">Status:</label>
                <select
                  class="form-select"
                  id="editStatus"
                  name="status"
                  [(ngModel)]="editTodoData.status"
                  required
                  #editStatus="ngModel"
                  [attr.aria-invalid]="
                    editStatus.invalid &&
                    (editStatus.dirty || editStatus.touched)
                      ? 'true'
                      : 'false'
                  "
                  aria-describedby="editStatusError"
                >
                  <option value="PENDING">Pending</option>
                  <option value="IN_PROGRESS">In Progress</option>
                  <option value="COMPLETED">Completed</option>
                  <option value="CANCELLED">Cancelled</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="">Add Subtasks:</label>
                <ul
                  class="list-unstyled"
                  style="display: flex; flex-direction: column; gap: 5px"
                >
                  <!-- Input for new task -->
                  <li>
                    <div class="input-group mb-3">
                      <input
                        type="text"
                        class="form-control"
                        id="subtaskInputEdit"
                        name="subtaskInputEdit"
                        [(ngModel)]="newTaskForEditModal"
                        [disabled]="!editTodoData.id"
                        (keydown.enter)="
                          addTaskOnEnter(editTodoData.id, 'edit');
                          $event.preventDefault()
                        "
                      />

                      <button
                        type="button"
                        class="btn btn-primary"
                        [disabled]="!editTodoData.id"
                        (click)="addTaskOnEnter(editTodoData.id, 'edit')"
                      >
                        <img
                          [src]="add"
                          style="width: auto; height: 20px"
                          alt=""
                        />
                      </button>
                    </div>
                  </li>
                </ul>
                <!-- Added field (End)----------------------------------------------------------------------->
              </div>
              <div class="col-md-6 mb-3">
                <label for="editPriority" class="form-label"> Priority: </label>
                <select
                  class="form-select"
                  id="editPriority"
                  name="priority"
                  [(ngModel)]="editTodoData.priority"
                >
                  <option value="CRITICAL">Critical/Urgent/High</option>
                  <option value="IMPORTANT">Important/High Priority</option>
                  <option value="NORMAL">Normal/Medium Priority</option>
                  <option value="LOW">Low Priority</option>
                </select>
              </div>
              <div class="row">
                <div
                  style="
                    background-color: rgb(255, 255, 255);
                    padding: 10px;
                    width: 100%;
                    border-radius: 5px;
                    color: black;
                    margin-left: 13px;
                  "
                >
                  <label class="form-label">Subtasks:</label>
                  <ul class="list-unstyled" *ngIf="editTodoData?.id">
                    <li
                      *ngFor="
                        let subtask of getFilteredSubtasksForEdit(
                          editTodoData.id
                        )
                      "
                    >
                      <input
                        type="checkbox"
                        [checked]="subtask.completed"
                        (change)="toggleComplete(subtask)"
                      />
                      <span
                        [ngClass]="{
                          'text-decoration-line-through': subtask.completed
                        }"
                      >
                        {{ subtask.subtasks }}
                      </span>
                      <button
                        type="button"
                        class="btn btn-sm ms-2"
                        (click)="editSubtask(subtask)"
                        title="Edit Subtask"
                        style="padding: 0.1rem 0.3rem; font-size: 0.7rem"
                      >
                        <img
                          [src]="edit"
                          style="width: 12px; height: 12px"
                          alt="Edit"
                        />
                      </button>
                      <button
                        type="button"
                        class="btn btn-sm ms-1"
                        (click)="deleteSubtask(subtask.id)"
                        title="Delete Subtask"
                        style="padding: 0.1rem 0.3rem; font-size: 0.7rem"
                      >
                        <img
                          [src]="delete"
                          style="width: 12px; height: 12px"
                          alt="Delete"
                        />
                      </button>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Close
              </button>
              <button
                type="submit"
                class="btn btn-primary"
                [disabled]="editTodoForm.invalid"
              >
                Save Changes
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  <!-- Edit Task Modal -->
</div>
<footer class="bg-dark text-white text-center py-3 mt-4">
  &copy; {{ currentYear }} Margelle Inc. All rights reserved.
</footer>
